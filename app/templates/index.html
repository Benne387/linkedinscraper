<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Scraper</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>LinkedIn Scraper</h1>
            <p style="color: var(--text-secondary)">Professional Webhook & Manual Tool</p>
        </header>

        <main>
            <!-- Configuration Section (Always Open) -->
            <div class="input-group"
                style="margin-bottom: 2rem; border: 1px solid rgba(59, 130, 246, 0.3); background: rgba(30, 41, 59, 0.5);">
                <div
                    style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">‚öôÔ∏è</span>
                    <span style="font-weight: 600; color: white;">Configuration & Authentication</span>
                </div>

                <div id="settings-panel" style="padding: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Login Form -->
                        <div>
                            <div class="section-title">Method 1: Auto Login</div>
                            <input type="email" id="email" placeholder="Email"
                                style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;">
                            <input type="password" id="password" placeholder="Password"
                                style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;">
                            <button onclick="performLogin()" style="width: 100%; justify-content: center;">
                                <span class="btn-text">Login</span>
                                <span class="loader hidden"></span>
                            </button>
                        </div>

                        <!-- Cookie Import -->
                        <div>
                            <div class="section-title">Method 2: Import Cookies (Reliable)</div>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Use
                                "EditThisCookie" extension to export cookies as JSON and paste here.</p>
                            <textarea id="cookieJson" rows="3" placeholder='[{"domain": ".linkedin.com", ...}]'
                                style="width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 0.5rem; padding: 0.5rem; margin-bottom: 0.5rem;"></textarea>
                            <button onclick="saveCookies()"
                                style="width: 100%; justify-content: center; background: #10b981;">
                                <span class="btn-text">Save Cookies</span>
                            </button>
                        </div>
                    </div>
                    <div id="auth-message" class="hidden"
                        style="margin-top: 1rem; padding: 0.5rem; border-radius: 0.5rem; text-align: center;"></div>
                </div>
            </div>

            <!-- Mode Switcher -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button onclick="switchMode('manual')" id="btn-mode-manual" class="mode-btn active"
                    style="flex: 1; justify-content: center; background: var(--accent);">
                    Manual Mode
                </button>
                <button onclick="switchMode('webhook')" id="btn-mode-webhook" class="mode-btn"
                    style="flex: 1; justify-content: center; background: transparent; border: 1px solid var(--accent);">
                    Webhook / API Mode
                </button>
            </div>

            <!-- Manual Mode UI -->
            <div id="mode-manual">
                <div class="input-group">
                    <div class="input-wrapper">
                        <input type="url" id="urlInput"
                            placeholder="Paste LinkedIn Profile URL (e.g., https://linkedin.com/in/...)" required>
                        <button id="scrapeBtn" onclick="scrapeProfile()">
                            <span class="btn-text">Scrape</span>
                            <span class="loader hidden"></span>
                        </button>
                    </div>
                </div>
                <!-- Action Buttons (Hidden until results) -->
                <div id="action-buttons" class="hidden"
                    style="display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: flex-end;">
                    <button onclick="downloadJSON()"
                        style="background: #6366f1; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ‚¨áÔ∏è Download JSON
                    </button>
                    <button onclick="downloadCSV()"
                        style="background: #10b981; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ‚¨áÔ∏è Download CSV
                    </button>
                </div>
                <div id="result-area"></div>
            </div>

            <!-- Webhook Mode UI -->
            <div id="mode-webhook" class="hidden"
                style="background: rgba(30, 41, 59, 0.5); padding: 2rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                <div class="section-title" style="font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span>ü§ñ</span> Automation / n8n Integration
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    To use this scraper in your automation workflows (n8n, Zapier, Make), send a POST request to the
                    endpoint below.
                </p>

                <div style="margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">POST Endpoint:</div>
                    <div
                        style="background: black; padding: 1rem; border-radius: 0.5rem; font-family: monospace; position: relative;">
                        <span id="api-url">http://localhost:5005/scrape</span>
                        <span
                            style="position: absolute; right: 1rem; top: 0.8rem; cursor: pointer; color: var(--accent);"
                            onclick="navigator.clipboard.writeText(document.getElementById('api-url').innerText)">Copy</span>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">JSON Body:</div>
                    <pre
                        style="background: black; padding: 1rem; border-radius: 0.5rem; font-family: monospace; color: #a5f3fc;">
{
  "url": "https://www.linkedin.com/in/example",
  "session_id": "<span id="client-id-display">default</span>"
}
                    </pre>
                    <p style="font-size: 0.8rem; color: orange; margin-top: 0.5rem;">
                        ‚ö†Ô∏è Important: Use the "session_id" above to reuse your currently authenticated session
                        configuration.
                    </p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global data storage for download
        let currentScrapedData = null;

        function switchMode(mode) {
            // Update Buttons
            document.getElementById('btn-mode-manual').style.background = mode === 'manual' ? 'var(--accent)' : 'transparent';
            document.getElementById('btn-mode-webhook').style.background = mode === 'webhook' ? 'var(--accent)' : 'transparent';

            // Toggle Views
            if (mode === 'manual') {
                document.getElementById('mode-manual').classList.remove('hidden');
                document.getElementById('mode-webhook').classList.add('hidden');
            } else {
                document.getElementById('mode-manual').classList.add('hidden');
                document.getElementById('mode-webhook').classList.remove('hidden');

                // Update Client ID display
                document.getElementById('client-id-display').textContent = getClientId();
                document.getElementById('api-url').textContent = window.location.origin + '/scrape';
            }
        }

        function getClientId() {
            let id = localStorage.getItem('scraper_client_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('scraper_client_id', id);
            }
            return id;
        }

        async function scrapeProfile() {
            const input = document.getElementById('urlInput');
            const btn = document.getElementById('scrapeBtn');
            const loader = btn.querySelector('.loader');
            const btnText = btn.querySelector('.btn-text');
            const resultArea = document.getElementById('result-area');
            const actionButtons = document.getElementById('action-buttons');

            if (!input.value) {
                alert('Please enter a URL');
                return;
            }

            // UI Loading State
            input.disabled = true;
            btn.disabled = true;
            loader.classList.remove('hidden');
            btnText.classList.add('hidden');
            resultArea.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Scraping... please wait...</div>';
            actionButtons.classList.add('hidden');

            try {
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: input.value,
                        session_id: getClientId()
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    try {
                        const json = JSON.parse(text);
                        throw new Error(json.error || `Server Error: ${response.status}`);
                    } catch (e) {
                        // Likely HTML (401/404/500)
                        throw new Error(`Server connection failed (${response.status}). Are you logged in?`);
                    }
                }

                const data = await response.json();
                currentScrapedData = data; // Store for download

                if (data.status === 'success') {
                    renderProfile(data);
                    actionButtons.classList.remove('hidden'); // Show download buttons
                } else {
                    renderError(data.error || 'Unknown error occurred');
                }
            } catch (error) {
                renderError(error.message);
            } finally {
                // Reset UI
                input.disabled = false;
                btn.disabled = false;
                loader.classList.add('hidden');
                btnText.classList.remove('hidden');
            }
        }

        // Download Functions
        function downloadJSON() {
            if (!currentScrapedData) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentScrapedData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", (currentScrapedData.name || "profile") + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function downloadCSV() {
            if (!currentScrapedData) return;

            // Flatten core fields
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Name", "Job Title", "Company", "Location", "Email", "Phone", "About", "URL"];
            csvContent += headers.join(",") + "\r\n";

            const row = [
                currentScrapedData.name,
                currentScrapedData.job_title,
                currentScrapedData.company,
                currentScrapedData.location,
                currentScrapedData.email || "",
                currentScrapedData.phone || "",
                (currentScrapedData.about || "").replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";"), // Sanitize
                currentScrapedData.url
            ];

            csvContent += row.map(e => `"${e || ''}"`).join(",") + "\r\n";

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", (currentScrapedData.name || "profile") + ".csv");
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function renderError(msg) {
            document.getElementById('result-area').innerHTML = `
                <div class="error-message">
                    <span>‚ö†Ô∏è</span> ${msg}
                </div>
            `;
        }

        function renderProfile(data) {
            const expHtml = data.experiences ? data.experiences.map(exp => `
                <div class="exp-item">
                    <div class="exp-title">${exp.position_title}</div>
                    <div class="exp-company">${exp.institution_name}</div>
                    <div class="exp-date">${exp.from_date} - ${exp.to_date} | ${exp.location}</div>
                </div>
            `).join('') : '';

            const eduHtml = data.educations ? data.educations.map(edu => `
                <div class="edu-item">
                    <div class="exp-title">${edu.institution_name}</div>
                    <div class="exp-company">${edu.degree}</div>
                    <div class="exp-date">${edu.from_date} - ${edu.to_date}</div>
                </div>
            `).join('') : '';

            const html = `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-name">${data.name}</div>
                        <div class="profile-title">${data.job_title} @ ${data.company}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem">üìç ${data.location}</div>
                    </div>
                    <div class="profile-body">
                        ${data.about && data.about !== 'N/A' ? `
                            <div class="section">
                                <div class="section-title">About</div>
                                <p style="color: var(--text-secondary); line-height: 1.6">${data.about}</p>
                            </div>
                        ` : ''}

                        ${expHtml ? `
                            <div class="section">
                                <div class="section-title">Experience</div>
                                ${expHtml}
                            </div>
                        ` : ''}

                        ${eduHtml ? `
                            <div class="section">
                                <div class="section-title">Education</div>
                                ${eduHtml}
                            </div>
                        ` : ''}

                        ${data.skills && data.skills.length > 0 ? `
                            <div class="section">
                                <div class="section-title">Skills</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem">
                                    ${data.skills.map(skill => `
                                        <span style="background: rgba(255,255,255,0.1); padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.9rem;">${skill}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${data.certifications && data.certifications.length > 0 ? `
                            <div class="section">
                                <div class="section-title">Certifications</div>
                                ${data.certifications.map(cert => `
                                    <div class="exp-item" style="margin-bottom: 0.5rem">
                                        <div class="exp-title">${cert.name}</div>
                                        <div class="exp-company">${cert.organization}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.languages && data.languages.length > 0 ? `
                            <div class="section">
                                <div class="section-title">Languages</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem">
                                    ${data.languages.map(lang => `
                                        <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 0.5rem;">
                                            <div style="font-weight: 600;">${lang.name}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${lang.proficiency}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="section">
                             <div class="section-title">Raw Data</div>
                             <details>
                                <summary style="cursor: pointer; color: var(--accent)">View JSON</summary>
                                <div class="json-view">${JSON.stringify(data, null, 2)}</div>
                             </details>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('result-area').innerHTML = html;
        }

        // Authentication Functions
        async function performLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('auth-message');

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            msg.className = '';
            msg.classList.remove('hidden');
            msg.textContent = 'Attempting login... this can take 10-30 seconds...';
            msg.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        session_id: getClientId()
                    })
                });

                if (!response.ok) throw new Error(`Status ${response.status}`);
                const data = await response.json();

                msg.textContent = data.message;
                msg.style.backgroundColor = data.status === 'success' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }

        async function saveCookies() {
            const cookies = document.getElementById('cookieJson').value;
            const msg = document.getElementById('auth-message');

            if (!cookies) return;

            msg.classList.remove('hidden');

            try {
                const response = await fetch('/cookies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cookies,
                        session_id: getClientId()
                    })
                });

                if (!response.ok) throw new Error(`Status ${response.status}`);
                const data = await response.json();

                msg.textContent = data.message;
                msg.style.backgroundColor = data.status === 'success' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            } catch (e) {
                msg.textContent = 'Error: ' + e.message;
            }
        }
    </script>
</body>

</html>